@model List<CinemaManagement.Models.Phim>

@{
    ViewData["Title"] = "Quản lý phim";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas fa-film me-2"></i>Quản lý phim
                    </h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#themPhimModal">
                        <i class="fas fa-plus me-1"></i>Thêm phim mới
                    </button>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <!-- Bộ lọc -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-filter me-2"></i>Bộ lọc và tìm kiếm
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="get" action="" id="filterForm">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="searchTerm" class="form-label">Tìm kiếm</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="searchTerm" 
                                                   name="searchTerm" 
                                                   value="@ViewBag.SearchTerm" 
                                                   placeholder="Tên phim hoặc mã phim...">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="theLoai" class="form-label">Thể loại</label>
                                            <select class="form-select" id="theLoaiFilter" name="theLoai">
                                                <option value="">Tất cả thể loại</option>
                                                @if (ViewBag.DanhSachTheLoai != null)
                                                {
                                                    @foreach (var theLoai in ViewBag.DanhSachTheLoai)
                                                    {
                                                        <option value="@theLoai" selected="@(ViewBag.TheLoai == theLoai)">@theLoai</option>
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="doTuoi" class="form-label">Độ tuổi</label>
                                            <select class="form-select" id="doTuoiFilter" name="doTuoi">
                                                <option value="">Tất cả độ tuổi</option>
                                                @if (ViewBag.DanhSachDoTuoi != null)
                                                {
                                                    @foreach (var doTuoi in ViewBag.DanhSachDoTuoi)
                                                    {
                                                        <option value="@doTuoi" selected="@(ViewBag.DoTuoi == doTuoi)">@doTuoi</option>
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="sortBy" class="form-label">Sắp xếp theo</label>
                                            <select class="form-select" id="sortBy" name="sortBy">
                                                <option value="TenPhim" selected="@(ViewBag.SortBy == "TenPhim")">Tên phim</option>
                                                <option value="MaPhim" selected="@(ViewBag.SortBy == "MaPhim")">Mã phim</option>
                                                <option value="TheLoai" selected="@(ViewBag.SortBy == "TheLoai")">Thể loại</option>
                                                <option value="ThoiLuong" selected="@(ViewBag.SortBy == "ThoiLuong")">Thời lượng</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">&nbsp;</label>
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-search me-1"></i>Lọc
                                                </button>
                                                <a href="@Url.Action("Index", "Phim")" class="btn btn-outline-secondary">
                                                    <i class="fas fa-refresh me-1"></i>Xóa bộ lọc
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Thống kê nhanh -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-info">
                                    <i class="fas fa-film"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Tổng số phim</span>
                                    <span class="info-box-number">@Model.Count</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-success">
                                    <i class="fas fa-tags"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Thể loại</span>
                                    <span class="info-box-number">@(Model.Select(p => p.TheLoai).Distinct().Count())</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning">
                                    <i class="fas fa-clock"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Thời lượng TB</span>
                                    <span class="info-box-number">@(Model.Any() ? Math.Round(Model.Average(p => p.ThoiLuong)) : 0) phút</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-danger">
                                    <i class="fas fa-star"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Phim dài nhất</span>
                                    <span class="info-box-number">@(Model.Any() ? Model.Max(p => p.ThoiLuong) : 0) phút</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Hình ảnh</th>
                                    <th>Mã phim</th>
                                    <th>Tên phim</th>
                                    <th>Thể loại</th>
                                    <th>Thời lượng</th>
                                    <th>Độ tuổi</th>
                                    <th>Mô tả</th>
                                    <th>Nhân viên quản lý</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var phim in Model)
                                {
                                    <tr class="movie-row">
                                        <td>
                                            @if (!string.IsNullOrEmpty(phim.ViTriFilePhim))
                                            {
                                                <a href="@Url.Action("ChiTiet", "Phim", new { id = phim.MaPhim })">
                                                    <img src="@phim.ViTriFilePhim" alt="@phim.TenPhim" class="img-thumbnail" style="width: 60px; height: 80px; object-fit: cover;">
                                                </a>
                                            }
                                            else
                                            {
                                                <a href="@Url.Action("ChiTiet", "Phim", new { id = phim.MaPhim })">
                                                    <div class="d-flex align-items-center justify-content-center bg-light" style="width: 60px; height: 80px; border-radius: 4px;">
                                                        <i class="fas fa-film text-muted"></i>
                                                    </div>
                                                </a>
                                            }
                                        </td>
                                        <td><span class="badge bg-secondary">@phim.MaPhim</span></td>
                                        <td>
                                            <a href="@Url.Action("ChiTiet", "Phim", new { id = phim.MaPhim })" class="text-decoration-none">
                                                <strong>@phim.TenPhim</strong>
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">@phim.TheLoai</span>
                                        </td>
                                        <td>@phim.ThoiLuong phút</td>
                                        <td>
                                            <span class="badge bg-warning">@phim.DoTuoiPhanAnh</span>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(phim.MoTa))
                                            {
                                                @if (phim.MoTa.Length > 50)
                                                {
                                                    @(phim.MoTa.Substring(0, 50) + "...")
                                                }
                                                else
                                                {
                                                    @phim.MoTa
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">Chưa có mô tả</span>
                                            }
                                        </td>
                                        <td>@(phim.NhanVien?.TenNhanVien ?? "Chưa có thông tin")</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" onclick="xoaPhim('@phim.MaPhim', '@phim.TenPhim')" title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (!Model.Any())
                    {
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            Hiện tại chưa có phim nào trong hệ thống.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm phim -->
<div class="modal fade" id="themPhimModal" tabindex="-1" aria-labelledby="themPhimModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="themPhimModalLabel">Thêm phim mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tenPhim" class="form-label">Tên phim</label>
                                <input type="text" class="form-control" id="tenPhim" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="theLoai" class="form-label">Thể loại</label>
                                <select class="form-select" id="theLoai" required>
                                    <option value="">Chọn thể loại</option>
                                    <option value="Hành động">Hành động</option>
                                    <option value="Kinh dị">Kinh dị</option>
                                    <option value="Tình cảm">Tình cảm</option>
                                    <option value="Hài hước">Hài hước</option>
                                    <option value="Khoa học viễn tưởng">Khoa học viễn tưởng</option>
                                    <option value="Hoạt hình">Hoạt hình</option>
                                    <option value="Tài liệu">Tài liệu</option>
                                    <option value="Khác">Khác</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="thoiLuong" class="form-label">Thời lượng (phút)</label>
                                <input type="number" class="form-control" id="thoiLuong" min="60" max="300" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="doTuoiPhanAnh" class="form-label">Độ tuổi phân ánh</label>
                                <select class="form-select" id="doTuoiPhanAnh" required>
                                    <option value="">Chọn độ tuổi</option>
                                    <option value="P">P - Phù hợp mọi độ tuổi</option>
                                    <option value="K">K - Dành cho trẻ em</option>
                                    <option value="T13">T13 - Từ 13 tuổi trở lên</option>
                                    <option value="T16">T16 - Từ 16 tuổi trở lên</option>
                                    <option value="T18">T18 - Từ 18 tuổi trở lên</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="moTa" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="moTa" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="viTriFilePhim" class="form-label">Hình ảnh phim</label>
                        <input type="url" class="form-control" id="viTriFilePhim" placeholder="URL hình ảnh poster của phim">
                        <div class="form-text">Nhập URL hình ảnh poster của phim</div>
                    </div>
                    <div class="mb-3" id="imagePreview" style="display: none;">
                        <label class="form-label">Xem trước hình ảnh:</label>
                        <div>
                            <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 300px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="themPhim()">Thêm phim</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal xem chi tiết phim -->
<div class="modal fade" id="chiTietModal" tabindex="-1" aria-labelledby="chiTietModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chiTietModalLabel">Chi tiết phim</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="chiTietModalBody">
                <!-- Nội dung chi tiết phim sẽ được load bằng JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal sửa phim -->
<div class="modal fade" id="suaPhimModal" tabindex="-1" aria-labelledby="suaPhimModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suaPhimModalLabel">Sửa thông tin phim</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editMaPhim">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTenPhim" class="form-label">Tên phim</label>
                                <input type="text" class="form-control" id="editTenPhim" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTheLoai" class="form-label">Thể loại</label>
                                <select class="form-select" id="editTheLoai" required>
                                    <option value="">Chọn thể loại</option>
                                    <option value="Hành động">Hành động</option>
                                    <option value="Kinh dị">Kinh dị</option>
                                    <option value="Tình cảm">Tình cảm</option>
                                    <option value="Hài hước">Hài hước</option>
                                    <option value="Khoa học viễn tưởng">Khoa học viễn tưởng</option>
                                    <option value="Hoạt hình">Hoạt hình</option>
                                    <option value="Tài liệu">Tài liệu</option>
                                    <option value="Khác">Khác</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editThoiLuong" class="form-label">Thời lượng (phút)</label>
                                <input type="number" class="form-control" id="editThoiLuong" min="60" max="300" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDoTuoiPhanAnh" class="form-label">Độ tuổi phân ánh</label>
                                <select class="form-select" id="editDoTuoiPhanAnh" required>
                                    <option value="">Chọn độ tuổi</option>
                                    <option value="P">P - Phù hợp mọi độ tuổi</option>
                                    <option value="K">K - Dành cho trẻ em</option>
                                    <option value="T13">T13 - Từ 13 tuổi trở lên</option>
                                    <option value="T16">T16 - Từ 16 tuổi trở lên</option>
                                    <option value="T18">T18 - Từ 18 tuổi trở lên</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMoTa" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="editMoTa" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editViTriFilePhim" class="form-label">Hình ảnh phim</label>
                        <input type="url" class="form-control" id="editViTriFilePhim" placeholder="URL hình ảnh poster của phim">
                        <div class="form-text">Nhập URL hình ảnh poster của phim</div>
                    </div>
                    <div class="mb-3" id="editImagePreview" style="display: none;">
                        <label class="form-label">Xem trước hình ảnh:</label>
                        <div>
                            <img id="editPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 300px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="capNhatPhim()">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Hàm xem chi tiết phim
    function xemChiTiet(maPhim) {
        console.log('Xem chi tiết phim:', maPhim);
        fetch('/Phim/ChiTietPhim?maPhim=' + maPhim)
            .then(response => response.json())
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    const phim = data.phim;
                    const modalBody = document.getElementById('chiTietModalBody');
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                ${phim.ViTriFilePhim ? 
                                    `<img src="${phim.ViTriFilePhim}" alt="${phim.TenPhim}" class="img-fluid rounded mb-3" style="max-height: 300px; width: 100%; object-fit: cover;">` : 
                                    `<div class="d-flex align-items-center justify-content-center bg-light rounded mb-3" style="height: 300px;">
                                        <i class="fas fa-film fa-3x text-muted"></i>
                                    </div>`
                                }
                            </div>
                            <div class="col-md-8">
                                <h6><strong>Mã phim:</strong> ${phim.MaPhim}</h6>
                                <h6><strong>Tên phim:</strong> ${phim.TenPhim}</h6>
                                <h6><strong>Thể loại:</strong> ${phim.TheLoai}</h6>
                                <h6><strong>Thời lượng:</strong> ${phim.ThoiLuong} phút</h6>
                                <h6><strong>Độ tuổi:</strong> ${phim.DoTuoiPhanAnh}</h6>
                                <h6><strong>Nhân viên quản lý:</strong> ${phim.NhanVien}</h6>
                                <h6><strong>Số lịch chiếu:</strong> ${phim.SoLichChieu}</h6>
                                <h6><strong>Số vé bán ra:</strong> ${phim.SoVeBanRa}</h6>
                                <h6><strong>Doanh thu:</strong> ${phim.DoanhThu ? phim.DoanhThu.toLocaleString('vi-VN') + ' VNĐ' : '0 VNĐ'}</h6>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6><strong>Mô tả:</strong></h6>
                            <p>${phim.MoTa}</p>
                        </div>
                    `;
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tải thông tin phim');
            });
    }

    // Hàm sửa phim
    function suaPhim(maPhim) {
        console.log('Sửa phim:', maPhim);
        fetch('/Phim/ChiTietPhim?maPhim=' + maPhim)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const phim = data.phim;
                    // Điền dữ liệu vào form sửa
                    document.getElementById('editMaPhim').value = phim.MaPhim;
                    document.getElementById('editTenPhim').value = phim.TenPhim;
                    document.getElementById('editTheLoai').value = phim.TheLoai;
                    document.getElementById('editThoiLuong').value = phim.ThoiLuong;
                    document.getElementById('editDoTuoiPhanAnh').value = phim.DoTuoiPhanAnh;
                    document.getElementById('editMoTa').value = phim.MoTa;
                    document.getElementById('editViTriFilePhim').value = phim.ViTriFilePhim || '';
                    
                    // Hiển thị preview hình ảnh nếu có
                    if (phim.ViTriFilePhim) {
                        document.getElementById('editPreviewImg').src = phim.ViTriFilePhim;
                        document.getElementById('editImagePreview').style.display = 'block';
                    } else {
                        document.getElementById('editImagePreview').style.display = 'none';
                    }
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tải thông tin phim');
            });
    }

    // Hàm xóa phim
    function xoaPhim(maPhim, tenPhim) {
        console.log('Xóa phim:', maPhim, tenPhim);
        if (confirm(`Bạn có chắc chắn muốn xóa phim "${tenPhim}" không?`)) {
            fetch('/Phim/XoaPhim', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'maPhim=' + encodeURIComponent(maPhim)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Xóa phim thành công!');
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa phim');
            });
        }
    }

    // Hàm thêm phim
    function themPhim() {
        console.log('Thêm phim mới');
        var tenPhim = document.getElementById('tenPhim').value;
        var theLoai = document.getElementById('theLoai').value;
        var thoiLuong = document.getElementById('thoiLuong').value;
        var doTuoiPhanAnh = document.getElementById('doTuoiPhanAnh').value;
        var moTa = document.getElementById('moTa').value;
        var viTriFilePhim = document.getElementById('viTriFilePhim').value;

        if (!tenPhim || !theLoai || !thoiLuong || !doTuoiPhanAnh || !moTa) {
            alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
            return;
        }

        fetch('/Phim/ThemPhim', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'tenPhim=' + encodeURIComponent(tenPhim) +
                  '&theLoai=' + encodeURIComponent(theLoai) +
                  '&thoiLuong=' + encodeURIComponent(thoiLuong) +
                  '&doTuoiPhanAnh=' + encodeURIComponent(doTuoiPhanAnh) +
                  '&moTa=' + encodeURIComponent(moTa) +
                  '&viTriFilePhim=' + encodeURIComponent(viTriFilePhim)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Thêm phim thành công!');
                // Đóng modal và reset form
                var modal = bootstrap.Modal.getInstance(document.getElementById('themPhimModal'));
                modal.hide();
                document.getElementById('createForm').reset();
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi thêm phim');
        });
    }

    // Hàm cập nhật phim
    function capNhatPhim() {
        console.log('Cập nhật phim');
        var maPhim = document.getElementById('editMaPhim').value;
        var tenPhim = document.getElementById('editTenPhim').value;
        var theLoai = document.getElementById('editTheLoai').value;
        var thoiLuong = document.getElementById('editThoiLuong').value;
        var doTuoiPhanAnh = document.getElementById('editDoTuoiPhanAnh').value;
        var moTa = document.getElementById('editMoTa').value;
        var viTriFilePhim = document.getElementById('editViTriFilePhim').value;

        if (!tenPhim || !theLoai || !thoiLuong || !doTuoiPhanAnh || !moTa) {
            alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
            return;
        }

        fetch('/Phim/SuaPhim', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'maPhim=' + encodeURIComponent(maPhim) +
                  '&tenPhim=' + encodeURIComponent(tenPhim) +
                  '&theLoai=' + encodeURIComponent(theLoai) +
                  '&thoiLuong=' + encodeURIComponent(thoiLuong) +
                  '&doTuoiPhanAnh=' + encodeURIComponent(doTuoiPhanAnh) +
                  '&moTa=' + encodeURIComponent(moTa) +
                  '&viTriFilePhim=' + encodeURIComponent(viTriFilePhim)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Cập nhật phim thành công!');
                // Đóng modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('suaPhimModal'));
                modal.hide();
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi cập nhật phim');
        });
    }

    // Preview hình ảnh khi nhập URL cho modal thêm phim
    document.getElementById('viTriFilePhim').addEventListener('input', function() {
        const url = this.value;
        const preview = document.getElementById('imagePreview');
        const img = document.getElementById('previewImg');
        
        if (url && isValidImageUrl(url)) {
            img.src = url;
            preview.style.display = 'block';
            img.onerror = function() {
                preview.style.display = 'none';
            };
        } else {
            preview.style.display = 'none';
        }
    });

    // Preview hình ảnh khi nhập URL cho modal sửa phim
    document.getElementById('editViTriFilePhim').addEventListener('input', function() {
        const url = this.value;
        const preview = document.getElementById('editImagePreview');
        const img = document.getElementById('editPreviewImg');
        
        if (url && isValidImageUrl(url)) {
            img.src = url;
            preview.style.display = 'block';
            img.onerror = function() {
                preview.style.display = 'none';
            };
        } else {
            preview.style.display = 'none';
        }
    });

    // Kiểm tra URL hình ảnh hợp lệ
    function isValidImageUrl(url) {
        try {
            new URL(url);
            return /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(url) || url.includes('imgur.com') || url.includes('cloudinary.com') || url.includes('amazonaws.com');
        } catch {
            return false;
        }
    }
</script>