@model CinemaManagement.Models.Phim

@{
    ViewData["Title"] = "Chi tiết phim - " + Model.TenPhim;
}

<div class="movie-detail-container">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card movie-info-card">
                    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-film me-2"></i>Chi tiết phim: @Model.TenPhim
                        </h3>
                        <div>
                            <a href="@Url.Action("Index", "Phim")" class="btn btn-light">
                                <i class="fas fa-arrow-left me-1"></i>Quay lại
                            </a>
                            @if (ViewBag.IsManager)
                            {
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editModal">
                                    <i class="fas fa-edit me-1"></i>Chỉnh sửa
                                </button>
                            }
                        </div>
                    </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div class="row">
                        <!-- Hình ảnh phim -->
                        <div class="col-md-4">
                            @if (!string.IsNullOrEmpty(Model.ViTriFilePhim))
                            {
                                <img src="@Model.ViTriFilePhim" alt="@Model.TenPhim" class="img-fluid movie-poster">
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center bg-light movie-poster" style="height: 400px;">
                                    <i class="fas fa-film fa-5x text-muted"></i>
                                </div>
                            }
                        </div>

                        <!-- Thông tin phim -->
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-barcode me-2"></i>Mã phim:</label>
                                        <span class="badge bg-primary fs-6">@Model.MaPhim</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-film me-2"></i>Tên phim:</label>
                                        <span class="info-value">@Model.TenPhim</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-tags me-2"></i>Thể loại:</label>
                                        <span class="badge bg-info fs-6">@Model.TheLoai</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-clock me-2"></i>Thời lượng:</label>
                                        <span class="info-value">@Model.ThoiLuong phút</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-users me-2"></i>Độ tuổi:</label>
                                        <span class="badge bg-warning text-dark fs-6">@Model.DoTuoiPhanAnh</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-user-tie me-2"></i>Nhân viên quản lý:</label>
                                        <span class="info-value">@(Model.NhanVien?.TenNhanVien ?? "Chưa có thông tin")</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-calendar me-2"></i>Số lịch chiếu:</label>
                                        <span class="badge bg-success fs-6">@ViewBag.SoLichChieu</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-ticket-alt me-2"></i>Số vé bán ra:</label>
                                        <span class="badge bg-danger fs-6">@ViewBag.SoVeBanRa</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="info-label"><i class="fas fa-dollar-sign me-2"></i>Doanh thu:</label>
                                        <span class="info-value text-success fw-bold">@string.Format("{0:N0}", ViewBag.DoanhThu) VNĐ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mô tả phim -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-align-left me-2"></i>Mô tả phim</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-0">@Model.MoTa</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thống kê nhanh -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-info">
                                    <i class="fas fa-calendar"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Lịch chiếu</span>
                                    <span class="info-box-number">@ViewBag.SoLichChieu</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-success">
                                    <i class="fas fa-ticket-alt"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Vé đã bán</span>
                                    <span class="info-box-number">@ViewBag.SoVeBanRa</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning">
                                    <i class="fas fa-dollar-sign"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Doanh thu</span>
                                    <span class="info-box-number">@string.Format("{0:N0}", ViewBag.DoanhThu)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-danger">
                                    <i class="fas fa-clock"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Thời lượng</span>
                                    <span class="info-box-number">@Model.ThoiLuong phút</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (ViewBag.IsManager)
{
    <!-- Modal chỉnh sửa phim -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Chỉnh sửa thông tin phim</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="maPhim" value="@Model.MaPhim">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenPhim" class="form-label">Tên phim</label>
                                    <input type="text" class="form-control" id="tenPhim" value="@Model.TenPhim" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="theLoai" class="form-label">Thể loại</label>
                                    <select class="form-select" id="theLoai" required>
                                        <option value="">Chọn thể loại</option>
                                        <option value="Hành động" selected="@(Model.TheLoai == "Hành động")">Hành động</option>
                                        <option value="Kinh dị" selected="@(Model.TheLoai == "Kinh dị")">Kinh dị</option>
                                        <option value="Tình cảm" selected="@(Model.TheLoai == "Tình cảm")">Tình cảm</option>
                                        <option value="Hài hước" selected="@(Model.TheLoai == "Hài hước")">Hài hước</option>
                                        <option value="Khoa học viễn tưởng" selected="@(Model.TheLoai == "Khoa học viễn tưởng")">Khoa học viễn tưởng</option>
                                        <option value="Hoạt hình" selected="@(Model.TheLoai == "Hoạt hình")">Hoạt hình</option>
                                        <option value="Tài liệu" selected="@(Model.TheLoai == "Tài liệu")">Tài liệu</option>
                                        <option value="Khác" selected="@(Model.TheLoai == "Khác")">Khác</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="thoiLuong" class="form-label">Thời lượng (phút)</label>
                                    <input type="number" class="form-control" id="thoiLuong" value="@Model.ThoiLuong" min="60" max="300" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="doTuoiPhanAnh" class="form-label">Độ tuổi phân ánh</label>
                                    <select class="form-select" id="doTuoiPhanAnh" required>
                                        <option value="">Chọn độ tuổi</option>
                                        <option value="P" selected="@(Model.DoTuoiPhanAnh == "P")">P - Phù hợp mọi độ tuổi</option>
                                        <option value="K" selected="@(Model.DoTuoiPhanAnh == "K")">K - Dành cho trẻ em</option>
                                        <option value="T13" selected="@(Model.DoTuoiPhanAnh == "T13")">T13 - Từ 13 tuổi trở lên</option>
                                        <option value="T16" selected="@(Model.DoTuoiPhanAnh == "T16")">T16 - Từ 16 tuổi trở lên</option>
                                        <option value="T18" selected="@(Model.DoTuoiPhanAnh == "T18")">T18 - Từ 18 tuổi trở lên</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="moTa" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="moTa" rows="4" required>@Model.MoTa</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="viTriFilePhim" class="form-label">Hình ảnh phim</label>
                            <input type="url" class="form-control" id="viTriFilePhim" value="@Model.ViTriFilePhim" placeholder="URL hình ảnh poster của phim">
                            <div class="form-text">Nhập URL hình ảnh poster của phim</div>
                        </div>
                        <div class="mb-3" id="imagePreview" style="@(!string.IsNullOrEmpty(Model.ViTriFilePhim) ? "display: block;" : "display: none;")">
                            <label class="form-label">Xem trước hình ảnh:</label>
                            <div>
                                <img id="previewImg" src="@Model.ViTriFilePhim" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 300px;">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="capNhatPhim()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .info-label {
        font-weight: 600;
        color: #495057;
        display: inline-block;
        min-width: 140px;
    }
    
    .info-value {
        font-weight: 500;
        color: #212529;
    }
    
    .info-item {
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
</style>

<script>
    // Preview hình ảnh khi nhập URL
    document.getElementById('viTriFilePhim').addEventListener('input', function() {
        const url = this.value;
        const preview = document.getElementById('imagePreview');
        const img = document.getElementById('previewImg');
        
        if (url && isValidImageUrl(url)) {
            img.src = url;
            preview.style.display = 'block';
            img.onerror = function() {
                preview.style.display = 'none';
            };
        } else {
            preview.style.display = 'none';
        }
    });

    // Kiểm tra URL hình ảnh hợp lệ
    function isValidImageUrl(url) {
        try {
            new URL(url);
            return /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(url) || url.includes('imgur.com') || url.includes('cloudinary.com') || url.includes('amazonaws.com');
        } catch {
            return false;
        }
    }

    // Hàm cập nhật phim
    function capNhatPhim() {
        var maPhim = document.getElementById('maPhim').value;
        var tenPhim = document.getElementById('tenPhim').value;
        var theLoai = document.getElementById('theLoai').value;
        var thoiLuong = document.getElementById('thoiLuong').value;
        var doTuoiPhanAnh = document.getElementById('doTuoiPhanAnh').value;
        var moTa = document.getElementById('moTa').value;
        var viTriFilePhim = document.getElementById('viTriFilePhim').value;

        if (!tenPhim || !theLoai || !thoiLuong || !doTuoiPhanAnh || !moTa) {
            alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
            return;
        }

        fetch('/Phim/SuaPhim', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'maPhim=' + encodeURIComponent(maPhim) +
                  '&tenPhim=' + encodeURIComponent(tenPhim) +
                  '&theLoai=' + encodeURIComponent(theLoai) +
                  '&thoiLuong=' + encodeURIComponent(thoiLuong) +
                  '&doTuoiPhanAnh=' + encodeURIComponent(doTuoiPhanAnh) +
                  '&moTa=' + encodeURIComponent(moTa) +
                  '&viTriFilePhim=' + encodeURIComponent(viTriFilePhim)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Cập nhật phim thành công!');
                // Đóng modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
                // Reload trang để cập nhật thông tin
                location.reload();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi cập nhật phim');
        });
    }
</script>
